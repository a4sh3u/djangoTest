#!groovy

node {

    stage 'Checkout'
      checkout scm
      sh "echo aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
    stage 'Build'
      sh 'docker-compose pull '
      sh 'docker-compose build'
      sh 'docker-compose up -d'

    stage 'Testing'
      sh 'docker exec poll /code/mysite/manage.py test /code/mysite'
      sh 'if [ $(curl -k -L -s -o /dev/null -w "%{http_code}" https://localhost/admin/) -ne 200 ]; then exit 1 ; fi'

    stage 'Cleanup'
      sh "docker-compose rm -fsv"
}
