#!groovy

node {

    stage 'Checkout'
      checkout scm

    stage 'Build'
      sh 'docker-compose pull '
      sh 'docker-compose build'
      sh 'docker-compose up -d'

    stage 'Testing'
      sh 'docker exec poll /code/mysite/manage.py test /code/mysite'
      sh 'if [ $(curl -k -L -s -o /dev/null -w "%{http_code}" https://localhost/admin/) -ne 200 ]; then exit 1 ; else echo "Service is fully functional"; fi'

    stage 'Deploy'
      sh 'docker build deploy/. -t ansible_boto'
      sh 'docker run --rm -e AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY -e AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION ansible_boto ansible-playbook -i /etc/ansible/hosts /deploy/aws_deploy.yml'
    stage 'Cleanup'
      sh "docker-compose rm -fsv"
}
